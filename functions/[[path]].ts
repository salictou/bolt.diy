import type { ServerBuild } from '@remix-run/cloudflare';
import { createPagesFunctionHandler } from '@remix-run/cloudflare-pages';

// @ts-ignore because the server build file is generated by `remix vite:build`
import * as serverBuild from '../build/server';

// Create the Remix handler
const remixHandler = createPagesFunctionHandler({
  build: serverBuild as unknown as ServerBuild,
});

// IP filtering logic: Fetch ALLOWED_IP from environment variables
export const onRequest: PagesFunction = async (context) => {
  try {
    // Get the IP address from the request headers (Cloudflare will add the real IP in 'cf-connecting-ip')
    const forwardedFor = context.request.headers.get('cf-connecting-ip') ||
                         context.request.headers.get('x-forwarded-for') ||
                         context.request.headers.get('x-real-ip') ||
                         '127.0.0.1';
    const requestIp = forwardedFor.split(',')[0].trim();

    // Fetch the allowed IP from environment variables
    const allowedIp = context.env.ALLOWED_IP;

    if (!allowedIp) {
      throw new Error("Environment variable ALLOWED_IP is not set.");
    }

    // Check if the request IP matches the allowed IP
    if (requestIp !== allowedIp) {
      // If not, return 403 Forbidden
      return new Response("Access Denied: Unauthorized IP address", {
        status: 403,
      });
    }

    // Fetch the password from environment variables
    const AUTH_TOKEN = context.env.AUTH_TOKEN;

    if (!AUTH_TOKEN) {
      throw new Error("Environment variable AUTH_TOKEN is not set.");
    }

    // Get the 'Authorization' header from the request
    const authHeader = context.request.headers.get("Authorization");
    const expectedAuth = `Basic ${btoa(`:${AUTH_TOKEN}`)}`; // Colon to skip username.

    // Check if the 'Authorization' header matches the expected value
    if (authHeader !== expectedAuth) {
      return new Response("Unauthorized", {
        status: 401,
        headers: { "WWW-Authenticate": 'Basic realm="Protected Area"' },
      });
    }

    // If both IP check and auth check succeed, forward the request to Remix
    return remixHandler(context);
  } catch (error) {
    // Log the error and return a 500 response
    console.error("Worker error:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
};
